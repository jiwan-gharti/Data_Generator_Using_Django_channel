{% extends 'base.html' %}

{% block title %}
    home
{% endblock title %}

{% block content %}

<div class="container">
    <div class="row">
        <div class="col-2">
        
        </div>
        <div class="col-8">
            <input placeholder="Enter number . . ." class="form-control" type="number" value="" id="input-value" onkeyup="checkForm()" >
            <br>
            <button class="mt-4 bg-primary text-white border-1 mb-5 form-control  form-submit" disabled type="submit">Generate</button>
        </div>
    </div>
</div>

<div class="continer">
        <div class="row">
        <div class="row mb-5">
            <div class="col-2"></div>
            <div class="col-8">
            <h4>Data Generated Status</h4>
            <hr>
            <p>Percent completed : <span id="complete"></span></p>
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            </div>
            <div class="col-2"></div>

        </div>

        
        <div class="col-2"></div>
        <div class="col-8">
            <table class="table">
                    <thead>
                        <tr>
                        <th scope="col">#</th>
                        <th scope="col">Name</th>
                        <th scope="col">Email</th>
                        <th scope="col">Address</th>
                        <th scope="col">age</th>

                        </tr>
                    </thead>
                <tbody class="data-section">
                </tbody>
            </table>
        </div>
        <div class="col-2"></div>
    </div>
</div>


    <script>

        document.querySelector(".form-submit").onclick = function(e){

                e.preventDefault()
                var url = '/create_student/';

                var inputElement = document.getElementById("input-value");
                data = {'total': inputElement.value}
                console.log(data)

              let csrftoken = getCookie('csrftoken');
              let response = fetch(url, {
                    method: 'POST',
                    body:   JSON.stringify(data),
                    headers: { 'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json',
                        "X-CSRFToken": csrftoken },
                })


                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }

                    
        }

        function checkForm(){
            console.log("keyup")
            var element = document.getElementById("input-value");
            if(element.value.length > 0){
                document.querySelector(".form-submit").removeAttribute('disabled')
            }else{
                document.querySelector(".form-submit").setAttribute('disabled',true)
            }

            };

        var url = "ws://localhost:8000/ws/data_generator/"

        var socket = new WebSocket(url);

        socket.onopen = function(event){
           console.log("connected!!!")
        }

        socket.onmessage = function(event){
           var data = JSON.parse(event.data)
           if(data.payload){
               addData(data.payload)
               increaseProgressBar(data.payload.total , data.payload.current_total)
           }
           console.log(data)
        }

        socket.onclose = function(event){
           console.log("connected!!!")
        }

        function addData(data){
            var html = `
                <tr>
                    <th scope="row">${data.id}</th>
                    <td>${data.student_name}</td>
                    <td>${data.student_email}</td>
                    <td>${data.student_address}</td>
                    <td>${data.student_age}</td>
                </tr>
            `
            document.querySelector(".data-section").innerHTML += html
        }
        

        function increaseProgressBar(total, currentValue){
            var progress = document.querySelector(".progress-bar")

            var percantage = (currentValue / total) * 100

            document.getElementById("complete").innerHTML = percantage + "%"
            progress.style.width = percantage + "%"

        }
    </script>


{% endblock content %}